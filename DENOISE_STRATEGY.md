# å‘Šè­¦é™å™ªç­–ç•¥è¯¦ç»†è®¾è®¡

## 1. é™å™ªçš„é‡è¦æ€§

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå‘Šè­¦é£æš´æ˜¯å¸¸è§é—®é¢˜ï¼š
- ğŸ“ˆ å•ä¸ªé—®é¢˜å¯èƒ½äº§ç”Ÿ**æˆåƒä¸Šä¸‡**æ¡å‘Šè­¦
- ğŸ” åŒä¸€é—®é¢˜åœ¨å¤šä¸ªå®ä¾‹ä¸Š**é‡å¤å‡ºç°**
- ğŸ”— ä¸€ä¸ªæ ¹å› é—®é¢˜å¼•å‘**çº§è”å‘Šè­¦**
- ğŸ“¢ å¤§é‡å™ªéŸ³å¯¼è‡´**çœŸæ­£é—®é¢˜è¢«æ·¹æ²¡**

**ç›®æ ‡**ï¼šé€šè¿‡æ™ºèƒ½é™å™ªï¼Œå°†å‘Šè­¦æ•°é‡å‡å°‘ **80-90%**ï¼ŒåŒæ—¶ä¸æ¼æ‰ä»»ä½•çœŸæ­£çš„é—®é¢˜ã€‚

---

## 2. é™å™ªç­–ç•¥ä½“ç³»

### 2.1 é™å™ªç­–ç•¥åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬ä¸€å±‚ï¼šè¿‡æ»¤å±‚ (Filter)                      â”‚
â”‚  - ç™½åå•/é»‘åå•è¿‡æ»¤                                      â”‚
â”‚  - ç¯å¢ƒè¿‡æ»¤ (æµ‹è¯•ç¯å¢ƒå‘Šè­¦)                                â”‚
â”‚  - å·²çŸ¥è¯¯æŠ¥è¿‡æ»¤                                           â”‚
â”‚  - ä½ä¼˜å…ˆçº§è¿‡æ»¤                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ è¿‡æ»¤åå‰©ä½™ 60-70%
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬äºŒå±‚ï¼šå»é‡å±‚ (Deduplication)               â”‚
â”‚  - æ—¶é—´çª—å£å»é‡ (5åˆ†é’Ÿå†…ç›¸åŒå‘Šè­¦åªä¿ç•™ä¸€æ¡)                â”‚
â”‚  - æŒ‡çº¹å»é‡ (ç›¸åŒæŒ‡çº¹çš„å‘Šè­¦èšåˆ)                          â”‚
â”‚  - å†…å®¹å»é‡ (å†…å®¹ç›¸ä¼¼åº¦å»é‡)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ å»é‡åå‰©ä½™ 30-40%
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬ä¸‰å±‚ï¼šèšåˆå±‚ (Aggregation)                 â”‚
â”‚  - æœåŠ¡çº§èšåˆ (åŒä¸€æœåŠ¡çš„å‘Šè­¦èšåˆ)                        â”‚
â”‚  - å®ä¾‹çº§èšåˆ (åŒä¸€å®ä¾‹çš„å‘Šè­¦èšåˆ)                        â”‚
â”‚  - æ—¶é—´æ®µèšåˆ (å›ºå®šæ—¶é—´çª—å£å†…èšåˆ)                        â”‚
â”‚  - å…³è”èšåˆ (è°ƒç”¨é“¾ç›¸å…³çš„å‘Šè­¦èšåˆ)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ èšåˆåå‰©ä½™ 10-20%
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬å››å±‚ï¼šåˆ†çº§å±‚ (Severity)                    â”‚
â”‚  - è‡ªåŠ¨åˆ†çº§ (P0-P4)                                      â”‚
â”‚  - å½±å“èŒƒå›´è¯„ä¼°                                           â”‚
â”‚  - ç´§æ€¥ç¨‹åº¦åˆ¤æ–­                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ æœ€ç»ˆè¾“å‡º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‘Šè­¦äº‹ä»¶ (Alert Event)                       â”‚
â”‚  - é«˜è´¨é‡å‘Šè­¦                                             â”‚
â”‚  - å¯æ“ä½œçš„ä¿¡æ¯                                           â”‚
â”‚  - æ˜ç¡®çš„ä¼˜å…ˆçº§                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. è¯¦ç»†é™å™ªç­–ç•¥

### 3.1 è¿‡æ»¤ç­–ç•¥

#### 3.1.1 ç¯å¢ƒè¿‡æ»¤

```java
@Component
public class EnvironmentFilter implements DenoiseFilter {

    @Autowired
    private AgentProperties properties;

    @Override
    public boolean shouldFilter(ExceptionInfo exception) {
        String env = exception.getEnvironment();

        // æµ‹è¯•ç¯å¢ƒå‘Šè­¦é»˜è®¤è¿‡æ»¤
        if ("test".equals(env) || "dev".equals(env)) {
            return properties.getFilter().isFilterTestEnv();
        }

        return false;
    }

    @Override
    public int getOrder() {
        return 100;  // æœ€å…ˆæ‰§è¡Œ
    }
}
```

#### 3.1.2 é»‘åå•è¿‡æ»¤

```java
@Component
public class BlacklistFilter implements DenoiseFilter {

    @Autowired
    private BlacklistRepository blacklistRepository;

    @Override
    public boolean shouldFilter(ExceptionInfo exception) {
        // æ£€æŸ¥å¼‚å¸¸ç±»å‹é»‘åå•
        if (isInBlacklist(exception.getExceptionType())) {
            return true;
        }

        // æ£€æŸ¥åŒ…è·¯å¾„é»‘åå•
        String errorClass = exception.getErrorClass();
        if (errorClass != null && matchesBlacklistPackage(errorClass)) {
            return true;
        }

        return false;
    }

    private boolean isInBlacklist(String exceptionType) {
        List<String> blacklist = blacklistRepository.getExceptionBlacklist();
        return blacklist.contains(exceptionType);
    }

    private boolean matchesBlacklistPackage(String className) {
        List<String> packageBlacklist = blacklistRepository.getPackageBlacklist();
        return packageBlacklist.stream()
            .anyMatch(className::startsWith);
    }

    @Override
    public int getOrder() {
        return 200;
    }
}
```

#### 3.1.3 å·²çŸ¥è¯¯æŠ¥è¿‡æ»¤

```java
@Component
public class FalsePositiveFilter implements DenoiseFilter {

    @Autowired
    private KnowledgeService knowledgeService;

    @Override
    public boolean shouldFilter(ExceptionInfo exception) {
        // ä»çŸ¥è¯†åº“æŸ¥è¯¢æ˜¯å¦ä¸ºå·²çŸ¥è¯¯æŠ¥
        String fingerprint = exception.getFingerprint();

        KnowledgeItem knowledge = knowledgeService.findByFingerprint(fingerprint);
        if (knowledge != null && knowledge.isFalsePositive()) {
            log.info("Filter false positive exception: {}",
                exception.getExceptionType());
            return true;
        }

        return false;
    }

    @Override
    public int getOrder() {
        return 300;
    }
}
```

#### 3.1.4 ä¸šåŠ¡å¼‚å¸¸è¿‡æ»¤

```java
@Component
public class BusinessExceptionFilter implements DenoiseFilter {

    /**
     * è¿‡æ»¤ä¸šåŠ¡å¼‚å¸¸ï¼ˆéç³»ç»Ÿé”™è¯¯ï¼‰
     */
    @Override
    public boolean shouldFilter(ExceptionInfo exception) {
        String exceptionType = exception.getExceptionType();

        // ä¸šåŠ¡å¼‚å¸¸é€šå¸¸ç»§æ‰¿è‡ª BusinessException
        if (exceptionType.contains("BusinessException") ||
            exceptionType.contains("BizException")) {
            // ä¸šåŠ¡å¼‚å¸¸é™ä½ä¼˜å…ˆçº§ï¼Œä¸å®Œå…¨è¿‡æ»¤
            exception.setSeverity("P4");
            exception.setNeedAlert(false);
            return false;  // ä¸è¿‡æ»¤ï¼Œä½†æ ‡è®°ä¸ºä½ä¼˜å…ˆçº§
        }

        return false;
    }

    @Override
    public int getOrder() {
        return 400;
    }
}
```

---

### 3.2 å»é‡ç­–ç•¥

#### 3.2.1 æ—¶é—´çª—å£å»é‡

```java
@Service
public class TimeWindowDeduplication {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private static final Duration WINDOW_SIZE = Duration.ofMinutes(5);

    /**
     * æ—¶é—´çª—å£å†…å»é‡
     */
    public boolean isDuplicate(ExceptionInfo exception) {
        String fingerprint = exception.getFingerprint();
        String key = "exception:dedup:" + fingerprint;

        // å°è¯•è®¾ç½® keyï¼Œå¦‚æœå·²å­˜åœ¨åˆ™è¡¨ç¤ºé‡å¤
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(key, exception.getTraceId(), WINDOW_SIZE);

        if (Boolean.FALSE.equals(success)) {
            // é‡å¤å‘Šè­¦ï¼Œå¢åŠ è®¡æ•°
            incrementCount(fingerprint);
            return true;
        }

        return false;
    }

    /**
     * å¢åŠ é‡å¤è®¡æ•°
     */
    private void incrementCount(String fingerprint) {
        String countKey = "exception:count:" + fingerprint;
        redisTemplate.opsForValue().increment(countKey);
        redisTemplate.expire(countKey, WINDOW_SIZE);
    }

    /**
     * è·å–é‡å¤æ¬¡æ•°
     */
    public long getCount(String fingerprint) {
        String countKey = "exception:count:" + fingerprint;
        String count = redisTemplate.opsForValue().get(countKey);
        return count != null ? Long.parseLong(count) : 0;
    }
}
```

#### 3.2.2 æŒ‡çº¹ç”Ÿæˆç®—æ³•

```java
@Service
public class FingerprintGenerator {

    /**
     * ç”Ÿæˆå¼‚å¸¸æŒ‡çº¹
     */
    public String generate(ExceptionInfo exception) {
        StringBuilder sb = new StringBuilder();

        // 1. å¼‚å¸¸ç±»å‹
        sb.append(exception.getExceptionType()).append("|");

        // 2. å‡ºé”™ä½ç½®ï¼ˆç±»å+æ–¹æ³•å+è¡Œå·ï¼‰
        if (exception.getErrorClass() != null) {
            sb.append(exception.getErrorClass()).append(".");
            sb.append(exception.getErrorMethod()).append(":");
            sb.append(exception.getErrorLine());
        } else {
            // å¦‚æœæ²¡æœ‰å‡ºé”™ä½ç½®ï¼Œä½¿ç”¨å †æ ˆçš„å‰ä¸¤å¸§
            sb.append(getStackFrameSignature(exception.getStackTrace()));
        }

        // 3. åº”ç”¨åç§°
        sb.append("|").append(exception.getAppName());

        // ç”Ÿæˆ MD5
        return DigestUtils.md5Hex(sb.toString());
    }

    /**
     * ä»å †æ ˆä¸­æå–ç­¾å
     */
    private String getStackFrameSignature(String stackTrace) {
        String[] lines = stackTrace.split("\n");
        StringBuilder sig = new StringBuilder();

        int count = 0;
        for (String line : lines) {
            if (line.trim().startsWith("at ") && !isFrameworkCode(line)) {
                sig.append(line.trim());
                if (++count >= 2) break;
            }
        }

        return sig.toString();
    }

    private boolean isFrameworkCode(String line) {
        return line.contains("org.springframework") ||
               line.contains("com.sun") ||
               line.contains("java.lang.reflect");
    }
}
```

#### 3.2.3 å†…å®¹ç›¸ä¼¼åº¦å»é‡

```java
@Service
public class SimilarityDeduplication {

    @Autowired
    private EmbeddingModel embeddingModel;

    private static final double SIMILARITY_THRESHOLD = 0.95;

    /**
     * åŸºäºå†…å®¹ç›¸ä¼¼åº¦å»é‡
     */
    public boolean isSimilar(ExceptionInfo exception, List<ExceptionInfo> recentExceptions) {
        // ç”Ÿæˆå½“å‰å¼‚å¸¸çš„å‘é‡
        String content = buildContent(exception);
        Embedding currentEmbedding = embeddingModel.embed(content).content();

        // ä¸æœ€è¿‘çš„å¼‚å¸¸æ¯”è¾ƒ
        for (ExceptionInfo recent : recentExceptions) {
            String recentContent = buildContent(recent);
            Embedding recentEmbedding = embeddingModel.embed(recentContent).content();

            // è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
            double similarity = cosineSimilarity(
                currentEmbedding.vector(),
                recentEmbedding.vector()
            );

            if (similarity >= SIMILARITY_THRESHOLD) {
                log.debug("Found similar exception, similarity: {}", similarity);
                return true;
            }
        }

        return false;
    }

    private String buildContent(ExceptionInfo exception) {
        return String.format("%s: %s in %s.%s",
            exception.getExceptionType(),
            exception.getExceptionMessage(),
            exception.getErrorClass(),
            exception.getErrorMethod()
        );
    }

    private double cosineSimilarity(float[] vectorA, float[] vectorB) {
        double dotProduct = 0.0;
        double normA = 0.0;
        double normB = 0.0;

        for (int i = 0; i < vectorA.length; i++) {
            dotProduct += vectorA[i] * vectorB[i];
            normA += Math.pow(vectorA[i], 2);
            normB += Math.pow(vectorB[i], 2);
        }

        return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
    }
}
```

---

### 3.3 èšåˆç­–ç•¥

#### 3.3.1 æœåŠ¡çº§èšåˆ

```java
@Service
public class ServiceAggregation {

    @Autowired
    private ExceptionRepository exceptionRepository;

    private static final Duration AGGREGATION_WINDOW = Duration.ofMinutes(10);

    /**
     * æŒ‰æœåŠ¡èšåˆå¼‚å¸¸
     */
    public AlertEvent aggregateByService(String appName) {
        LocalDateTime startTime = LocalDateTime.now().minus(AGGREGATION_WINDOW);

        // æŸ¥è¯¢æ—¶é—´çª—å£å†…è¯¥æœåŠ¡çš„æ‰€æœ‰å¼‚å¸¸
        List<ExceptionInfo> exceptions = exceptionRepository
            .findByAppNameAndOccurredAtAfter(appName, startTime);

        if (exceptions.isEmpty()) {
            return null;
        }

        // åˆ›å»ºå‘Šè­¦äº‹ä»¶
        AlertEvent event = new AlertEvent();
        event.setEventId(UUID.randomUUID().toString());
        event.setAppName(appName);
        event.setEventType("SERVICE_EXCEPTION");
        event.setExceptionCount(exceptions.size());
        event.setFirstOccurredAt(exceptions.get(0).getOccurredAt());
        event.setLastOccurredAt(exceptions.get(exceptions.size() - 1).getOccurredAt());

        // ç»Ÿè®¡å„ç±»å¼‚å¸¸
        Map<String, Long> exceptionStats = exceptions.stream()
            .collect(Collectors.groupingBy(
                ExceptionInfo::getExceptionType,
                Collectors.counting()
            ));
        event.setExceptionStats(exceptionStats);

        // æå–æœ€é«˜ä¸¥é‡çº§åˆ«
        String highestSeverity = exceptions.stream()
            .map(ExceptionInfo::getSeverity)
            .min(Comparator.naturalOrder())
            .orElse("P4");
        event.setSeverity(highestSeverity);

        // ç”Ÿæˆæ‘˜è¦
        event.setSummary(buildSummary(appName, exceptions, exceptionStats));

        return event;
    }

    private String buildSummary(String appName, List<ExceptionInfo> exceptions,
                                 Map<String, Long> stats) {
        StringBuilder sb = new StringBuilder();
        sb.append(String.format("æœåŠ¡ %s åœ¨è¿‡å» %d åˆ†é’Ÿå†…å‘ç”Ÿ %d æ¬¡å¼‚å¸¸\n",
            appName, AGGREGATION_WINDOW.toMinutes(), exceptions.size()));

        sb.append("å¼‚å¸¸åˆ†å¸ƒï¼š\n");
        stats.entrySet().stream()
            .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
            .limit(5)
            .forEach(entry -> sb.append(String.format("  - %s: %d æ¬¡\n",
                getSimpleExceptionName(entry.getKey()), entry.getValue())));

        return sb.toString();
    }

    private String getSimpleExceptionName(String fullName) {
        int lastDot = fullName.lastIndexOf('.');
        return lastDot > 0 ? fullName.substring(lastDot + 1) : fullName;
    }
}
```

#### 3.3.2 å®ä¾‹çº§èšåˆ

```java
@Service
public class InstanceAggregation {

    /**
     * æŒ‰å®ä¾‹èšåˆå¼‚å¸¸
     */
    public Map<String, List<ExceptionInfo>> aggregateByInstance(
            List<ExceptionInfo> exceptions) {

        return exceptions.stream()
            .collect(Collectors.groupingBy(
                e -> e.getHostName() + ":" + e.getHostIp()
            ));
    }

    /**
     * æ£€æµ‹æ˜¯å¦ä¸ºå…¨å±€æ•…éšœ
     */
    public boolean isGlobalFailure(Map<String, List<ExceptionInfo>> instanceMap) {
        // å¦‚æœè¶…è¿‡ 80% çš„å®ä¾‹éƒ½å‡ºç°å¼‚å¸¸ï¼Œè®¤ä¸ºæ˜¯å…¨å±€æ•…éšœ
        int totalInstances = instanceMap.size();
        long failedInstances = instanceMap.values().stream()
            .filter(list -> list.size() > 5)  // è¶…è¿‡ 5 æ¬¡å¼‚å¸¸è®¤ä¸ºå¤±è´¥
            .count();

        double failureRate = (double) failedInstances / totalInstances;
        return failureRate >= 0.8;
    }
}
```

#### 3.3.3 è°ƒç”¨é“¾å…³è”èšåˆ

```java
@Service
public class CallChainAggregation {

    @Autowired
    private ExceptionRepository exceptionRepository;

    /**
     * æ ¹æ®è°ƒç”¨é“¾èšåˆå¼‚å¸¸
     */
    public List<AlertEvent> aggregateByCallChain(List<ExceptionInfo> exceptions) {
        // æŒ‰ traceId åˆ†ç»„
        Map<String, List<ExceptionInfo>> traceGroups = exceptions.stream()
            .filter(e -> e.getTraceId() != null)
            .collect(Collectors.groupingBy(ExceptionInfo::getTraceId));

        List<AlertEvent> events = new ArrayList<>();

        for (Map.Entry<String, List<ExceptionInfo>> entry : traceGroups.entrySet()) {
            String traceId = entry.getKey();
            List<ExceptionInfo> chainExceptions = entry.getValue();

            if (chainExceptions.size() > 1) {
                // å¤šä¸ªæœåŠ¡çš„è°ƒç”¨é“¾å¼‚å¸¸ï¼Œèšåˆä¸ºä¸€ä¸ªäº‹ä»¶
                AlertEvent event = createCallChainEvent(traceId, chainExceptions);
                events.add(event);
            }
        }

        return events;
    }

    private AlertEvent createCallChainEvent(String traceId,
                                            List<ExceptionInfo> exceptions) {
        // æ‰¾åˆ°æ ¹å› å¼‚å¸¸ï¼ˆæœ€æ—©å‘ç”Ÿçš„ï¼‰
        ExceptionInfo rootCause = exceptions.stream()
            .min(Comparator.comparing(ExceptionInfo::getOccurredAt))
            .orElseThrow();

        AlertEvent event = new AlertEvent();
        event.setEventId(UUID.randomUUID().toString());
        event.setEventType("CALL_CHAIN_FAILURE");
        event.setTraceId(traceId);
        event.setRootCauseService(rootCause.getAppName());
        event.setAffectedServices(exceptions.stream()
            .map(ExceptionInfo::getAppName)
            .distinct()
            .collect(Collectors.toList()));

        event.setSummary(String.format(
            "è°ƒç”¨é“¾æ•…éšœ (TraceId: %s)ï¼Œæ ¹å› æœåŠ¡: %sï¼Œå½±å“ %d ä¸ªæœåŠ¡",
            traceId,
            rootCause.getAppName(),
            event.getAffectedServices().size()
        ));

        return event;
    }
}
```

---

### 3.4 è‡ªåŠ¨åˆ†çº§ç­–ç•¥

#### 3.4.1 åˆ†çº§è§„åˆ™å¼•æ“

```java
@Service
public class SeverityEvaluator {

    /**
     * è¯„ä¼°å¼‚å¸¸ä¸¥é‡çº§åˆ«
     */
    public String evaluate(ExceptionInfo exception, AlertContext context) {
        int score = 0;

        // è§„åˆ™ 1: å¼‚å¸¸ç±»å‹æƒé‡
        score += evaluateExceptionType(exception.getExceptionType());

        // è§„åˆ™ 2: å½±å“èŒƒå›´
        score += evaluateImpactScope(context);

        // è§„åˆ™ 3: é¢‘ç‡
        score += evaluateFrequency(exception.getFingerprint(), context);

        // è§„åˆ™ 4: ä¸šåŠ¡é‡è¦æ€§
        score += evaluateBusinessImportance(exception.getAppName());

        // è§„åˆ™ 5: æ—¶é—´å› ç´ 
        score += evaluateTimeFactor(exception.getOccurredAt());

        // æ ¹æ®æ€»åˆ†æ˜ å°„åˆ°çº§åˆ«
        return mapScoreToSeverity(score);
    }

    private int evaluateExceptionType(String exceptionType) {
        // è‡´å‘½å¼‚å¸¸
        if (exceptionType.contains("OutOfMemoryError") ||
            exceptionType.contains("StackOverflowError")) {
            return 40;
        }

        // æ•°æ®åº“å¼‚å¸¸
        if (exceptionType.contains("SQLException") ||
            exceptionType.contains("DataAccessException")) {
            return 30;
        }

        // ç½‘ç»œå¼‚å¸¸
        if (exceptionType.contains("IOException") ||
            exceptionType.contains("TimeoutException")) {
            return 20;
        }

        // ç©ºæŒ‡é’ˆç­‰å¸¸è§å¼‚å¸¸
        if (exceptionType.contains("NullPointerException")) {
            return 15;
        }

        // ä¸šåŠ¡å¼‚å¸¸
        if (exceptionType.contains("BusinessException")) {
            return 5;
        }

        return 10;  // é»˜è®¤
    }

    private int evaluateImpactScope(AlertContext context) {
        int affectedInstances = context.getAffectedInstanceCount();
        int totalInstances = context.getTotalInstanceCount();

        double impactRate = (double) affectedInstances / totalInstances;

        if (impactRate >= 0.8) return 30;  // å½±å“è¶…è¿‡ 80%
        if (impactRate >= 0.5) return 20;  // å½±å“è¶…è¿‡ 50%
        if (impactRate >= 0.2) return 10;  // å½±å“è¶…è¿‡ 20%

        return 5;
    }

    private int evaluateFrequency(String fingerprint, AlertContext context) {
        long count = context.getOccurrenceCount(fingerprint);

        if (count >= 100) return 20;  // è¶…è¿‡ 100 æ¬¡
        if (count >= 50) return 15;   // è¶…è¿‡ 50 æ¬¡
        if (count >= 10) return 10;   // è¶…è¿‡ 10 æ¬¡

        return 5;
    }

    private int evaluateBusinessImportance(String appName) {
        // æ ¸å¿ƒæœåŠ¡
        if (isCoreService(appName)) {
            return 20;
        }

        // é‡è¦æœåŠ¡
        if (isImportantService(appName)) {
            return 10;
        }

        return 5;
    }

    private int evaluateTimeFactor(LocalDateTime occurredAt) {
        int hour = occurredAt.getHour();

        // é«˜å³°æœŸ (9:00-12:00, 14:00-18:00)
        if ((hour >= 9 && hour < 12) || (hour >= 14 && hour < 18)) {
            return 10;
        }

        // ä½å³°æœŸ
        return 5;
    }

    private String mapScoreToSeverity(int score) {
        if (score >= 80) return "P0";  // ç´§æ€¥
        if (score >= 60) return "P1";  // ä¸¥é‡
        if (score >= 40) return "P2";  // é‡è¦
        if (score >= 20) return "P3";  // ä¸€èˆ¬
        return "P4";  // æç¤º
    }

    private boolean isCoreService(String appName) {
        return Arrays.asList("user-service", "order-service", "payment-service")
            .contains(appName);
    }

    private boolean isImportantService(String appName) {
        return Arrays.asList("product-service", "inventory-service")
            .contains(appName);
    }
}

@Data
public class AlertContext {
    private int affectedInstanceCount;
    private int totalInstanceCount;
    private Map<String, Long> occurrenceMap;

    public long getOccurrenceCount(String fingerprint) {
        return occurrenceMap.getOrDefault(fingerprint, 0L);
    }
}
```

---

## 4. é™å™ªæµç¨‹ç¼–æ’

### 4.1 é™å™ªæµç¨‹å¼•æ“

```java
@Service
public class DenoiseEngine {

    @Autowired
    private List<DenoiseFilter> filters;

    @Autowired
    private TimeWindowDeduplication timeWindowDedup;

    @Autowired
    private ServiceAggregation serviceAggregation;

    @Autowired
    private SeverityEvaluator severityEvaluator;

    /**
     * æ‰§è¡Œé™å™ªæµç¨‹
     */
    public DenoiseResult process(ExceptionInfo exception) {
        DenoiseResult result = new DenoiseResult();
        result.setOriginalException(exception);

        try {
            // ç¬¬ä¸€å±‚ï¼šè¿‡æ»¤
            if (shouldFilter(exception)) {
                result.setFiltered(true);
                result.setReason("Filtered by rules");
                return result;
            }

            // ç¬¬äºŒå±‚ï¼šå»é‡
            if (timeWindowDedup.isDuplicate(exception)) {
                result.setDuplicate(true);
                result.setReason("Duplicate in time window");

                // è™½ç„¶æ˜¯é‡å¤ï¼Œä½†æ›´æ–°è®¡æ•°
                long count = timeWindowDedup.getCount(exception.getFingerprint());
                result.setOccurrenceCount(count);

                return result;
            }

            // ç¬¬ä¸‰å±‚ï¼šèšåˆ
            AlertEvent event = serviceAggregation.aggregateByService(
                exception.getAppName()
            );
            result.setAlertEvent(event);

            // ç¬¬å››å±‚ï¼šåˆ†çº§
            AlertContext context = buildAlertContext(exception);
            String severity = severityEvaluator.evaluate(exception, context);
            exception.setSeverity(severity);
            result.setSeverity(severity);

            result.setPassed(true);

        } catch (Exception e) {
            log.error("Failed to process denoise", e);
            result.setError(true);
            result.setReason(e.getMessage());
        }

        return result;
    }

    private boolean shouldFilter(ExceptionInfo exception) {
        // æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰è¿‡æ»¤å™¨
        return filters.stream()
            .sorted(Comparator.comparingInt(DenoiseFilter::getOrder))
            .anyMatch(filter -> filter.shouldFilter(exception));
    }

    private AlertContext buildAlertContext(ExceptionInfo exception) {
        // æ„å»ºå‘Šè­¦ä¸Šä¸‹æ–‡ï¼ˆç”¨äºåˆ†çº§ï¼‰
        AlertContext context = new AlertContext();
        // ... å¡«å……ä¸Šä¸‹æ–‡ä¿¡æ¯
        return context;
    }
}

@Data
public class DenoiseResult {
    private ExceptionInfo originalException;
    private boolean filtered;         // æ˜¯å¦è¢«è¿‡æ»¤
    private boolean duplicate;        // æ˜¯å¦é‡å¤
    private boolean error;            // æ˜¯å¦å¤„ç†é”™è¯¯
    private boolean passed;           // æ˜¯å¦é€šè¿‡ï¼ˆéœ€è¦å‘Šè­¦ï¼‰
    private String reason;            // åŸå› 
    private Long occurrenceCount;     // å‡ºç°æ¬¡æ•°
    private AlertEvent alertEvent;    // å‘Šè­¦äº‹ä»¶
    private String severity;          // ä¸¥é‡çº§åˆ«
}
```

---

## 5. é…ç½®åŒ–é™å™ªè§„åˆ™

### 5.1 é™å™ªè§„åˆ™é…ç½®

```yaml
# é™å™ªé…ç½®
one-agent:
  denoise:
    # æ˜¯å¦å¯ç”¨é™å™ª
    enabled: true

    # è¿‡æ»¤è§„åˆ™
    filters:
      # ç¯å¢ƒè¿‡æ»¤
      environment:
        enabled: true
        filter-test-env: true
        filter-dev-env: false

      # é»‘åå•
      blacklist:
        enabled: true
        exception-types:
          - org.springframework.security.access.AccessDeniedException
          - javax.validation.ValidationException
        packages:
          - org.springframework.web.servlet
          - com.sun

      # ç™½åå•ï¼ˆä¼˜å…ˆçº§é«˜äºé»‘åå•ï¼‰
      whitelist:
        enabled: false
        exception-types:
          - java.lang.OutOfMemoryError
          - java.lang.StackOverflowError

    # å»é‡é…ç½®
    deduplication:
      time-window: 5m  # æ—¶é—´çª—å£
      similarity-threshold: 0.95  # ç›¸ä¼¼åº¦é˜ˆå€¼

    # èšåˆé…ç½®
    aggregation:
      enabled: true
      window: 10m
      strategies:
        - SERVICE  # æŒ‰æœåŠ¡èšåˆ
        - INSTANCE # æŒ‰å®ä¾‹èšåˆ
        - CALL_CHAIN # æŒ‰è°ƒç”¨é“¾èšåˆ

    # åˆ†çº§é…ç½®
    severity:
      auto-evaluate: true
      rules:
        - type: EXCEPTION_TYPE
          weight: 40
        - type: IMPACT_SCOPE
          weight: 30
        - type: FREQUENCY
          weight: 20
        - type: BUSINESS_IMPORTANCE
          weight: 10

      # æ ¸å¿ƒæœåŠ¡åˆ—è¡¨
      core-services:
        - user-service
        - order-service
        - payment-service
```

---

## 6. ç›‘æ§æŒ‡æ ‡

### 6.1 é™å™ªæ•ˆæœæŒ‡æ ‡

```java
@Component
public class DenoiseMetrics {

    @Autowired
    private MeterRegistry meterRegistry;

    /**
     * è®°å½•é™å™ªæŒ‡æ ‡
     */
    public void recordDenoiseResult(DenoiseResult result) {
        // æ€»å¼‚å¸¸æ•°
        meterRegistry.counter("exception.total").increment();

        if (result.isFiltered()) {
            // è¢«è¿‡æ»¤æ•°
            meterRegistry.counter("exception.filtered").increment();
        } else if (result.isDuplicate()) {
            // é‡å¤æ•°
            meterRegistry.counter("exception.duplicate").increment();
        } else if (result.isPassed()) {
            // é€šè¿‡æ•°ï¼ˆçœŸæ­£çš„å‘Šè­¦ï¼‰
            meterRegistry.counter("exception.passed").increment();

            // æŒ‰çº§åˆ«ç»Ÿè®¡
            meterRegistry.counter("exception.severity",
                "level", result.getSeverity()).increment();
        }
    }

    /**
     * è®¡ç®—é™å™ªç‡
     */
    public double getDenoiseRate() {
        double total = meterRegistry.counter("exception.total").count();
        double passed = meterRegistry.counter("exception.passed").count();

        if (total == 0) return 0;

        return (total - passed) / total * 100;
    }
}
```

---

## 7. æ€»ç»“

é€šè¿‡**å››å±‚é™å™ªç­–ç•¥**ï¼Œå¯ä»¥å°†å‘Šè­¦æ•°é‡ä»**æµ·é‡**é™ä½åˆ°**å¯ç®¡ç†**çš„ç¨‹åº¦ï¼š

```
100,000 æ¡åŸå§‹å¼‚å¸¸
    â†“ ç¬¬ä¸€å±‚è¿‡æ»¤ (40% è¿‡æ»¤)
60,000 æ¡
    â†“ ç¬¬äºŒå±‚å»é‡ (50% å»é‡)
30,000 æ¡
    â†“ ç¬¬ä¸‰å±‚èšåˆ (70% èšåˆ)
9,000 æ¡
    â†“ ç¬¬å››å±‚åˆ†çº§ (å…³æ³¨ P0-P2)
~3,000 æ¡ é«˜è´¨é‡å‘Šè­¦
```

**æœ€ç»ˆæ•ˆæœ**ï¼š
- ğŸ“‰ å‘Šè­¦æ•°é‡å‡å°‘ **97%**
- âœ… é›¶æ¼æŠ¥ç‡
- ğŸ¯ é«˜è´¨é‡å‘Šè­¦
- âš¡ å¿«é€Ÿå“åº”çœŸæ­£çš„é—®é¢˜
